// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String      @id @default(cuid())
  email     String      @unique
  name      String
  createdAt DateTime    @default(now())

  jobs         Job[]
  jobEvents    JobEvent[]
  gmailAccount GmailAccount?
  emailGroups  EmailGroup[]
}

model GmailAccount {
  id            String    @id @default(cuid())
  userId        String    @unique
  gmailEmail    String
  accessToken   String    @db.Text
  refreshToken  String    @db.Text
  tokenExpiry   DateTime
  lastSyncAt    DateTime?
  lastHistoryId String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailGroup {
  id              String     @id @default(cuid())
  userId          String
  jobId           String?
  gmailThreadId   String?
  companyKey      String?
  emailCount      Int        @default(1)
  latestEventType EventType?
  firstEmailAt    DateTime   @default(now())
  lastEmailAt     DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  job    Job?  @relation(fields: [jobId], references: [id])
  emails EmailMessage[]

  @@unique([userId, gmailThreadId])
  @@index([userId, companyKey])
  @@index([userId, lastEmailAt])
}

model Job {
  id          String      @id @default(cuid())
  userId      String
  company     String
  position    String
  source      String?
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  events      JobEvent[]
  emailGroups EmailGroup[]

  @@unique([userId, company, position])
  @@index([userId])
  @@index([company, position])
}

model JobEvent {
  id              String      @id @default(cuid())
  jobId           String
  userId          String
  emailMessageId  String?     @unique
  type            EventType
  status          EventStatus @default(PENDING)
  extractedData   Json?
  rawData         Json?
  confirmedAt     DateTime?
  rejectedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  job             Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailMessage    EmailMessage? @relation(fields: [emailMessageId], references: [id])

  @@index([userId, status])
  @@index([jobId])
}

model EmailMessage {
  id             String      @id @default(cuid())
  subject        String
  body           String      @db.Text
  sender         String
  receivedAt     DateTime    @default(now())
  rawHeaders     Json?
  gmailMessageId String?     @unique
  gmailThreadId  String?
  groupId        String?
  createdAt      DateTime    @default(now())

  jobEvent JobEvent?
  group    EmailGroup? @relation(fields: [groupId], references: [id])
}

enum EventType {
  APPLICATION_RECEIVED
  INTERVIEW_REQUEST
  INTERVIEW_SCHEDULED
  ASSESSMENT
  OFFER
  REJECTION
  RECRUITER_OUTREACH
  OTHER
}

enum EventStatus {
  PENDING
  CONFIRMED
  REJECTED
}
